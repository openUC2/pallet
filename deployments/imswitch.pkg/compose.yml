services:

  imswitch-noqt:
    image: ghcr.io/openuc2/imswitch-noqt:sha-c1383c0@sha256:b0abc0aea112fc13e76c45560b433af4091f3c083cd58601c4c8adc4d3503269
    privileged: true
    ports:
      - "8001:8001" # frontend, HTTP API, WebSockets API
      - "8888:8888" # Jupyter
    volumes:
      - /etc/machine-id:/etc/machine-id:ro
      - /home/pi/ImSwitchConfig:/config
      - /home/pi/Datasets:/datasets
      - /media:/media
    environment:
      - HEADLESS=1
      - HTTP_PORT=8001
      - CONFIG_PATH=/config
      - CONFIG_FILE=example_virtual_microscope.json
      - UPDATE_GIT=0
      - UPDATE_CONFIG=0
      - DATA_PATH=/datasets
      - SCAN_EXT_DATA_PATH=1
      - EXT_DATA_PATH=/media
      - SSL=0
    restart: always

  volume-setup:
    # This service ensures that root isn't the owner of /home/pi/Datasets and
    # /home/pi/ImSwitchConfig, since Docker auto-creates those paths if they didn't exist before
    # for the bind mounts, and Docker creates such directories with root ownership.
    image: docker.io/library/alpine:3.22.2@sha256:4b7ce07002c69e8f3d704a9c5d6fd3053be500b7f1c69fc0d80990c2ad8dd412
    volumes:
      - /home/pi/Datasets:/home/pi/Datasets
    command: 'sh -c "chown -R 1000:1000 /home/pi/Datasets /home/pi/ImSwitchConfig; sleep 60"'
